<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>单词发音练习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
        }
        
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .recording-animation {
            animation: recording 1.5s ease-in-out infinite;
        }
        
        @keyframes recording {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .mic-pulse {
            animation: micPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes micPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <!-- 头部 -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">发音练习</h1>
                        <p class="text-sm text-gray-500">提升英语发音准确性</p>
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="wordCounter">单词 1 / 3</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-6 py-8">
        <!-- 练习界面 -->
        <div id="practiceSection" class="bg-white rounded-2xl shadow-xl p-8">
            <!-- 错误提示 -->
            <div id="errorAlert" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                <span id="errorMessage"></span>
            </div>

            <!-- 单词信息 -->
            <div class="text-center mb-8">
                <h2 id="currentWord" class="text-4xl font-bold text-gray-800 mb-3">apple</h2>
                <div class="inline-flex items-center bg-gray-100 px-4 py-2 rounded-full mb-4">
                    <span id="pronunciation" class="text-lg text-gray-600">/ˈæp.əl/</span>
                </div>
                <p id="meaning" class="text-xl text-gray-600">苹果</p>
            </div>

            <!-- 音标显示 -->
            <div class="bg-gray-50 rounded-xl p-6 mb-8">
                <h3 class="text-sm font-semibold text-gray-700 mb-4">音标分解</h3>
                <div id="phoneticDisplay" class="flex flex-wrap justify-center gap-3">
                    <!-- 音标会动态生成 -->
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="space-y-6">
                <!-- 示范音频按钮 -->
                <div class="text-center">
                    <button id="demoButton" class="inline-flex items-center space-x-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>听示范发音</span>
                    </button>
                </div>

                <!-- 录音控制 -->
                <div class="text-center space-y-4">
                    <button id="recordButton" class="inline-flex items-center space-x-2 bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 mic-pulse">
                        <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
                        <span>开始录音</span>
                    </button>
                    <div id="recordingTimer" class="hidden text-sm text-gray-500">
                        录音时长: <span id="timer">00:00</span>
                    </div>
                </div>

                <!-- 停止录音按钮 -->
                <div id="stopRecordingSection" class="hidden text-center">
                    <button id="stopButton" class="inline-flex items-center space-x-2 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200">
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
                        <span>停止录音</span>
                    </button>
                </div>

                <!-- 提交按钮 -->
                <div id="submitSection" class="hidden text-center pt-4">
                    <button id="submitButton" class="inline-flex items-center space-x-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>提交分析</span>
                    </button>
                </div>

                <!-- 录音播放器 -->
                <div id="audioPlayerSection" class="hidden mt-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">你的录音</h4>
                    <audio id="audioPlayer" class="w-full" controls></audio>
                </div>
            </div>
        </div>

        <!-- 结果界面 -->
        <div id="resultsSection" class="hidden bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">练习完成！</h2>
                <p class="text-gray-600">这是你的发音分析结果</p>
            </div>

            <!-- 总体评分 -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-8 text-white text-center mb-8">
                <div id="overallScore" class="text-6xl font-bold mb-2">85</div>
                <div class="text-xl opacity-90">综合评分</div>
                <div id="recordingTimeDisplay" class="mt-4 text-lg opacity-80">录音时长: 00:05</div>
            </div>

            <!-- 反馈 -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-8">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">📝 练习反馈</h3>
                <p id="feedbackText" class="text-yellow-700">发音不错，某些音节可以更清晰</p>
            </div>

            <!-- 音标详细评分 -->
            <div class="bg-gray-50 rounded-xl p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">音标详细评分</h3>
                <div id="detailedScores" class="space-y-4">
                    <!-- 详细评分会动态生成 -->
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="retryButton" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold transition-colors">
                    重新练习
                </button>
                <button id="nextButton" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-8 py-3 rounded-xl font-semibold transition-all">
                    下一个单词
                </button>
            </div>
        </div>

        <!-- 导航 -->
        <div class="flex justify-center mt-8 space-x-4">
            <button id="prevWordBtn" class="flex items-center space-x-2 px-6 py-3 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span>上一个</span>
            </button>
            <button id="nextWordBtn" class="flex items-center space-x-2 px-6 py-3 border border-gray-300 rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">
                <span>下一个</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </main>

    <!-- 底部 -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>发音练习系统 © 2024 | 提升你的英语发音能力</p>
    </footer>

    <script>
        // 单词数据
        const words = [
            {
                word: "apple",
                pronunciation: "/ˈæp.əl/",
                phonetic: ["æ", "p", "ə", "l"],
                meaning: "苹果"
            },
            {
                word: "beautiful",
                pronunciation: "/ˈbjuː.tɪ.fəl/",
                phonetic: ["b", "j", "uː", "t", "ɪ", "f", "ə", "l"],
                meaning: "美丽的"
            },
            {
                word: "chocolate",
                pronunciation: "/ˈtʃɒk.ələt/",
                phonetic: ["tʃ", "ɒ", "k", "ə", "l", "ə", "t"],
                meaning: "巧克力"
            }
        ];

        let currentWordIndex = 0;
        let isRecording = false;
        let recordingTime = 0;
        let recordingInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioUrl = '';
        let utterance = null;

        // DOM元素
        const elements = {
            practiceSection: document.getElementById('practiceSection'),
            resultsSection: document.getElementById('resultsSection'),
            currentWord: document.getElementById('currentWord'),
            pronunciation: document.getElementById('pronunciation'),
            meaning: document.getElementById('meaning'),
            phoneticDisplay: document.getElementById('phoneticDisplay'),
            demoButton: document.getElementById('demoButton'),
            recordButton: document.getElementById('recordButton'),
            stopRecordingSection: document.getElementById('stopRecordingSection'),
            stopButton: document.getElementById('stopButton'),
            submitSection: document.getElementById('submitSection'),
            submitButton: document.getElementById('submitButton'),
            audioPlayerSection: document.getElementById('audioPlayerSection'),
            audioPlayer: document.getElementById('audioPlayer'),
            errorAlert: document.getElementById('errorAlert'),
            errorMessage: document.getElementById('errorMessage'),
            recordingTimer: document.getElementById('recordingTimer'),
            timer: document.getElementById('timer'),
            wordCounter: document.getElementById('wordCounter'),
            overallScore: document.getElementById('overallScore'),
            recordingTimeDisplay: document.getElementById('recordingTimeDisplay'),
            feedbackText: document.getElementById('feedbackText'),
            detailedScores: document.getElementById('detailedScores'),
            retryButton: document.getElementById('retryButton'),
            nextButton: document.getElementById('nextButton'),
            prevWordBtn: document.getElementById('prevWordBtn'),
            nextWordBtn: document.getElementById('nextWordBtn')
        };

        // 显示错误
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorAlert.classList.remove('hidden');
            setTimeout(() => {
                elements.errorAlert.classList.add('hidden');
            }, 5000);
        }

        // 格式化时间
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 更新单词显示
        function updateWordDisplay() {
            const wordData = words[currentWordIndex];
            
            elements.currentWord.textContent = wordData.word;
            elements.pronunciation.textContent = wordData.pronunciation;
            elements.meaning.textContent = wordData.meaning;
            elements.wordCounter.textContent = `单词 ${currentWordIndex + 1} / ${words.length}`;
            
            // 更新音标显示
            elements.phoneticDisplay.innerHTML = '';
            wordData.phonetic.forEach(phoneme => {
                const div = document.createElement('div');
                div.className = 'bg-white px-4 py-2 rounded-lg shadow-sm border';
                div.innerHTML = `<span class="text-lg font-mono text-gray-800">${phoneme}</span>`;
                elements.phoneticDisplay.appendChild(div);
            });
        }

        // 播放示范音频
        function playDemo() {
            // 清除之前的语音
            if (utterance) {
                speechSynthesis.cancel();
            }
            
            try {
                utterance = new SpeechSynthesisUtterance(words[currentWordIndex].word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onend = function() {
                    elements.demoButton.disabled = false;
                };
                
                utterance.onerror = function() {
                    showError('语音播放出错');
                    elements.demoButton.disabled = false;
                };
                
                elements.demoButton.disabled = true;
                speechSynthesis.speak(utterance);
            } catch (err) {
                showError('语音合成功能不可用');
            }
        }

        // 开始录音
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    elements.audioPlayer.src = audioUrl;
                };

                mediaRecorder.onerror = function(event) {
                    console.error('录音错误:', event);
                    showError('录音出错: ' + event.error);
                };

                mediaRecorder.start();
                isRecording = true;
                recordingTime = 0;
                
                // 更新UI
                elements.recordButton.innerHTML = `
                    <div class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
                    <span>录音中...</span>
                `;
                elements.recordButton.classList.remove('from-red-500', 'to-pink-600');
                elements.recordButton.classList.add('from-gray-500', 'to-gray-600');
                
                elements.stopRecordingSection.classList.remove('hidden');
                elements.recordingTimer.classList.remove('hidden');
                
                // 开始计时
                if (recordingInterval) {
                    clearInterval(recordingInterval);
                }
                recordingInterval = setInterval(() => {
                    recordingTime++;
                    elements.timer.textContent = formatTime(recordingTime);
                }, 1000);
            } catch (error) {
                console.error('麦克风访问失败:', error);
                if (error.name === 'NotAllowedError') {
                    showError('请允许麦克风权限');
                } else if (error.name === 'NotFoundError') {
                    showError('未找到麦克风设备');
                } else if (error.name === 'NotReadableError') {
                    showError('麦克风被占用');
                } else {
                    showError('无法访问麦克风: ' + error.message);
                }
            }
        }

        // 停止录音
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // 清理计时器
                if (recordingInterval) {
                    clearInterval(recordingInterval);
                    recordingInterval = null;
                }
                
                // 更新UI
                elements.recordButton.innerHTML = `
                    <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
                    <span>开始录音</span>
                `;
                elements.recordButton.classList.remove('from-gray-500', 'to-gray-600');
                elements.recordButton.classList.add('from-red-500', 'to-pink-600');
                
                elements.stopRecordingSection.classList.add('hidden');
                elements.submitSection.classList.remove('hidden');
                elements.audioPlayerSection.classList.remove('hidden');
            }
        }

        // 提交录音进行分析
        function submitRecording() {
            if (!audioUrl) {
                showError('请先录制音频');
                return;
            }
            
            // 模拟分析结果
            const wordData = words[currentWordIndex];
            const phoneticScores = wordData.phonetic.map((phoneme, index) => ({
                phoneme,
                score: Math.floor(Math.random() * 30) + 70,
                feedback: Math.random() > 0.5 ? "发音准确" : "需要改进"
            }));

            const overallScore = Math.floor(
                phoneticScores.reduce((sum, item) => sum + item.score, 0) / phoneticScores.length
            );

            const feedback = overallScore >= 90 
                ? "发音非常标准！继续保持！" 
                : overallScore >= 80 
                    ? "发音不错，某些音节可以更清晰" 
                    : "需要多加练习，注意音节连贯性";

            // 显示结果
            elements.overallScore.textContent = overallScore;
            elements.recordingTimeDisplay.textContent = `录音时长: ${formatTime(recordingTime)}`;
            elements.feedbackText.textContent = feedback;
            
            // 生成详细评分
            elements.detailedScores.innerHTML = '';
            phoneticScores.forEach(score => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-white rounded-lg shadow-sm';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-mono font-semibold text-gray-800">${score.phoneme}</span>
                        <span class="text-sm text-gray-500">${score.feedback}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-24 bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${score.score >= 90 ? 'bg-green-500' : score.score >= 80 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${score.score}%"></div>
                        </div>
                        <span class="text-sm font-semibold w-12 text-right">${score.score}</span>
                    </div>
                `;
                elements.detailedScores.appendChild(div);
            });
            
            // 切换界面
            elements.practiceSection.classList.add('hidden');
            elements.resultsSection.classList.remove('hidden');
        }

        // 重新练习
        function resetPractice() {
            // 清理录音资源
            if (mediaRecorder && mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            if (utterance) {
                speechSynthesis.cancel();
            }
            if (recordingInterval) {
                clearInterval(recordingInterval);
            }
            
            // 重置状态
            isRecording = false;
            recordingTime = 0;
            audioUrl = '';
            mediaRecorder = null;
            audioChunks = [];
            
            // 重置UI
            elements.practiceSection.classList.remove('hidden');
            elements.resultsSection.classList.add('hidden');
            elements.recordButton.innerHTML = `
                <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
                <span>开始录音</span>
            `;
            elements.recordButton.classList.remove('from-gray-500', 'to-gray-600');
            elements.recordButton.classList.add('from-red-500', 'to-pink-600');
            elements.recordButton.disabled = false;
            
            elements.stopRecordingSection.classList.add('hidden');
            elements.submitSection.classList.add('hidden');
            elements.audioPlayerSection.classList.add('hidden');
            elements.recordingTimer.classList.add('hidden');
            
            elements.audioPlayer.src = '';
            elements.timer.textContent = '00:00';
        }

        // 切换单词
        function nextWord() {
            if (!elements.resultsSection.classList.contains('hidden')) {
                resetPractice();
            }
            currentWordIndex = (currentWordIndex + 1) % words.length;
            updateWordDisplay();
        }

        function prevWord() {
            if (!elements.resultsSection.classList.contains('hidden')) {
                resetPractice();
            }
            currentWordIndex = (currentWordIndex - 1 + words.length) % words.length;
            updateWordDisplay();
        }

        // 事件监听器
        elements.demoButton.addEventListener('click', playDemo);
        elements.recordButton.addEventListener('click', startRecording);
        elements.stopButton.addEventListener('click', stopRecording);
        elements.submitButton.addEventListener('click', submitRecording);
        elements.retryButton.addEventListener('click', resetPractice);
        elements.nextButton.addEventListener('click', nextWord);
        elements.prevWordBtn.addEventListener('click', prevWord);
        elements.nextWordBtn.addEventListener('click', nextWord);

        // 初始化
        updateWordDisplay();

        // 处理页面卸载
        window.addEventListener('beforeunload', function() {
            if (utterance) {
                speechSynthesis.cancel();
            }
            if (mediaRecorder && mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            if (recordingInterval) {
                clearInterval(recordingInterval);
            }
        });
    </script>
</body>
</html>